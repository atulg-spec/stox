{% extends 'dashboard/base.html' %}
{% block body %}

<div class="mb-4 bg-white border-b border-gray-200 dark:border-gray-700 overflow-x-auto mt-2">
    <ul class="flex flex-nowrap -mb-px font-medium text-center" id="default" data-tabs-toggle="#default-content"
        data-tabs-active-classes="text-purple-600 hover:text-purple-600 dark:text-purple-500 dark:hover:text-purple-500 border-purple-600 dark:border-purple-500"
        data-tabs-inactive-classes="dark:border-transparent text-gray-500 hover:text-indigo-600 dark:text-gray-400 border-gray-100 hover:border-gray-300 dark:border-gray-700 dark:hover:text-gray-300"
        role="tablist">
        {% for x in watchlist_list %}
        <li class="me-2" role="presentation">
            <button class="watchlist-tab inline-block p-4 border-b-2 rounded-t-lg text-indigo-600" id="{{x}}-tab"
                data-tabs-target="#styled-profile" type="button" role="tab" aria-controls="profile"
                aria-selected="false">{{x}}</button>
        </li>
        {% endfor %}
    </ul>
</div>
<div id="mt-2">
    {% for x in watchlist_list %}
    <div class="hidden watchlist-tab-main p-4 rounded-lg bg-white dark:bg-gray-800" id="{{x}}-tab-main" role="tabpanel"
        aria-labelledby="profile-tab">
        <div role="status"
            class="w-full p-4 space-y-4 border border-gray-200 divide-y divide-gray-200 rounded dark:divide-gray-700 md:p-6 dark:border-gray-700">
            {% for stock in watch_list %}
            <div class="flex items-center justify-between" id="{{stock.instrument_key}}">
                
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="mt-2" id="skeleton">
    <div role="status"
        class="w-full p-4 space-y-4 bg-white border border-gray-200 divide-y divide-gray-200 rounded shadow animate-pulse dark:divide-gray-700 md:p-6 dark:border-gray-700">
        <div class="flex items-center justify-between">
            <div>
                <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-600 w-24 mb-2.5"></div>
                <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </div>
            <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-700 w-12"></div>
        </div>
        <div class="flex items-center justify-between pt-4">
            <div>
                <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-600 w-24 mb-2.5"></div>
                <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </div>
            <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-700 w-12"></div>
        </div>
        <div class="flex items-center justify-between pt-4">
            <div>
                <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-600 w-24 mb-2.5"></div>
                <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </div>
            <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-700 w-12"></div>
        </div>
        <div class="flex items-center justify-between pt-4">
            <div>
                <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-600 w-24 mb-2.5"></div>
                <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </div>
            <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-700 w-12"></div>
        </div>
        <div class="flex items-center justify-between pt-4">
            <div>
                <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-600 w-24 mb-2.5"></div>
                <div class="w-32 h-2 bg-gray-200 rounded-full dark:bg-gray-700"></div>
            </div>
            <div class="h-2.5 bg-gray-300 rounded-full dark:bg-gray-700 w-12"></div>
        </div>
        <span class="sr-only">Loading...</span>
    </div>
</div>

<script>
    function openWatchlist(elementId) {
        otherTabsButtons = document.querySelectorAll('.watchlist-tab');
        otherTabsButtons.forEach((element) => {
            element.classList.remove('text-indigo-600')
        });

        document.getElementById(elementId).classList.add('text-indigo-600')

        const otherTabs = document.querySelectorAll('.watchlist-tab-main');
        otherTabs.forEach((element) => {
            element.classList.add('hidden')
        });
        document.getElementById(`${elementId}-main`).classList.remove('hidden')
    }

    // Select all elements with class 'tab-click'
    const tabClickElements = document.querySelectorAll('.watchlist-tab');

    // Attach event listener to each element
    tabClickElements.forEach((element) => {
        element.addEventListener('click', () => openWatchlist(element.id));
    });


    const socket = new WebSocket('ws://localhost:8000/ws/stocks/');

    socket.onopen = function () {
        console.log('WebSocket connection established.');

        // Example instruments list
        const instruments = {{watchlist_symbollist|safe}};

    // Send instruments list to the server
    socket.send(JSON.stringify(instruments));
    document.getElementById('skeleton').classList.add('hidden')
    if (tabClickElements.length > 0) {
        // Click the first element
        tabClickElements[0].click();
    } else {
        console.error('No elements found with the class name .watchlist-tab');
    }
    };

    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        console.log('Received real-time data:', data);
        for(let i of data) {
            document.getElementById(i['instrument']).innerHTML = `
            <div>
                    <div class="h-2.5 dark:bg-gray-600 text-gray-950 w-24 mb-2.5 mt-2">${i['data']['symbol']}</div>
                    <div class="w-32 h-2 text-sm text-gray-950 dark:bg-gray-700">${i['data']['segment']}</div>
                </div>
                <div>
                    <div class="h-2.5 dark:bg-gray-700 w-12">${i['data']['ltp']}</div>
                    <div class="h-2.5 text-green-600 text-sm mt-2 dark:bg-gray-700 w-12">10%</div>
                </div>
            `
            console.log(i['data']['symbol'])
        }

        // Handle the real-time data update here
    };

    socket.onclose = function (event) {
        const otherTabs = document.querySelectorAll('.watchlist-tab-main');
        otherTabs.forEach((element) => {
            element.classList.add('hidden')
        });
        document.getElementById('skeleton').classList.remove('hidden')
        console.log('WebSocket connection closed:', event);
        setTimeout(function () {
            location.reload();
        }, 5000);

    };

    socket.onerror = function (error) {
        const otherTabs = document.querySelectorAll('.watchlist-tab-main');
        otherTabs.forEach((element) => {
            element.classList.add('hidden')
        });
        document.getElementById('skeleton').classList.remove('hidden')
        console.error('WebSocket error:', error);
        setTimeout(function () {
            location.reload();
        }, 5000);

    };


</script>
<br><br><br><br>
{% endblock body %}